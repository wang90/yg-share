<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>阳光大数据</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no, shrink-to-fit=no">
    <link rel="stylesheet" href="./share.css">
</head>
<body id = 'node'>
<div id = "loading">
    <div class="loading-box">
        <div class="loading">
            <span></span>
            <span></span>
            <span></span>
            <span></span>
            <span></span>
        </div>
        <p>正在获取阳光大数据...</p>
    </div>

</div>
<div id = "searchBox">
    <div class="search-box">
        <h4 class="black">LEAD</h4>
        <div class="search-input search-item">
            <input type="text" class="black" placeholder="填写您的阳光帐号" id="searchValue">
        </div>
        <div class="search-button search-item clearfix">
            <div class="button black fl" onclick="searchName()" id="searchButton">搜索</div>
            <div class="button black fr" onclick="closeSearch()">取消</div>
        </div>
        <img src="./image/search-img.jpg" alt="">
    </div>
</div>
<div id = 'noSearchBox'>
    <div class="search-box noSearch-box">
        <img src="./image/noSearch.jpg" alt="">
        <p class="black">皮卡丘万分抱歉</p>
        <p class="black">未能帮你找相应的用户数据</p>
        <div class="item makeTable">
            <div class="button black" onclick="openSearch(1);">
                <p>制作我的</p>
                <p>阳光大数据</p>
            </div>
        </div>
    </div>
</div>
<div id ="main">
    <div id = "showShare">
        <div class="item">
            <div class="logo">
                <img src="./image/lead-logo.png" alt="">
            </div>
            <h2 class="title-bj yellow-title" id="user">阳光公益报告</h2>
            <div class="user-headpoirt" id ='userName'>
                <img src="" alt="">
                <p class="yellow p-text"></p>
            </div>
            <div class="html-padding" id = 'joinFirstInfo'>
                <!--<p class="write p-html tl">Hi,亲爱的阳光er,</p>-->
                <!--<p class="write p-html tl">欢迎进入阳光回忆之旅！</p>-->
                <!--<p class="yellow p-html tl">2013年9月1日</p>-->
                <!--<p class="write p-html tl">你注册了论坛，加入了阳光大家庭！</p>-->
                <!--<p class="yellow p-html tr">2013年3月7日</p>-->
                <!--<p class="write p-html tr">你参加了阳光的信任培训。</p>-->
                <!--<p class="yellow p-html tr">孙铭、kkiwi、赠可以、heas</p>-->
                <!--<p class="write p-html tr">等阳光er是你的同期生。</p>-->
            </div>
        </div>
        <div class="item" id="firstInfo">
            <!--<h2 class="title-bj yellow-title">公益活动报告</h2>-->
            <!--<div class="html-padding">-->
            <!--<p class="yellow p-html tr">崔各庄小学国学班</p>-->
            <!--<p class="write p-html tr">是你服务的第一个项目点</p>-->
            <!--</div>-->
            <!--<div class="html-padding">-->
            <!--<p class="yellow p-html tr">2013年9月1日</p>-->
            <!--<p class="write p-html tr">你第一次登上讲台，成为主讲。</p>-->
            <!--</div>-->
        </div>
        <div class="item" id="countNumber">
            <!--<h2 class="title-bj yellow-title">截止目前</h2>-->
            <!--<p class="write p-text">您参与的阳光公益活动</p>-->
            <!--<p class="yellow p-text">400次</p>-->
            <!--<ul class="list html-padding">-->
            <!--<li class="yellow">-->
            <!--<p class="p-html-title">周末课堂</p>-->
            <!--<img src="" alt="">-->
            <!--<p>236次</p>-->
            <!--</li>-->
            <!--<li class="yellow">-->
            <!--<p class="p-html-title">周末课堂</p>-->
            <!--<img src="" alt="">-->
            <!--<p>236次</p>-->
            <!--</li>-->
            <!--<li class="yellow">-->
            <!--<p class="p-html-title">周末课堂</p>-->
            <!--<img src="" alt="">-->
            <!--<p>236次</p>-->
            <!--</li>-->
            <!--<li class="yellow">-->
            <!--<p class="p-html-title">周末课堂</p>-->
            <!--<img src="" alt="">-->
            <!--<p>236次</p>-->
            <!--</li>-->
            <!--<li class="yellow">-->
            <!--<p class="p-html-title">周末课堂</p>-->
            <!--<img src="" alt="">-->
            <!--<p>236次</p>-->
            <!--</li>-->
            <!--</ul>-->
        </div>
        <div class="item" id ='constTime'>
            <!--<h2 class="title-bj yellow-title">截止目前</h2>-->
            <!--<p class="write p-text">您已为阳光公益支教活动服务</p>-->
            <!--<p class="yellow p-text">818小时</p>-->
            <!--<div class="html-padding">-->
            <!--<p class="write p-html tl">服务过的项目点包括</p>-->
            <!--<p class="yellow p-html tl">崔各庄小学、平西符宏立学校、木兰社区、爱加倍社区、费家村社区</p>-->
            <!--<p class="write p-html tl">等<span class="yellow">17</span>个项目点</p>-->
            <!--</div>-->
            <!--<div class="html-padding">-->
            <!--<p class="write p-html tr">开发原型教案</p>-->
            <!--<p class="yellow p-html tr">46个</p>-->
            <!--</div>-->
            <!--<div class="html-padding">-->
            <!--<p class="write p-html tl">服务流动儿童</p>-->
            <!--<p class="yellow p-html tl">230+</p>-->
            <!--</div>-->
        </div>
        <div class="item" id="alertJoin">
            <!--<h2 class="title-bj yellow-title">2009-2018</h2>-->
            <!--<p class="write p-text">阳光 <span class="yellow">玖</span>年了</p>-->
            <!--<p class="write p-text">感谢你的辛勤付出</p>-->
            <!--<p class="write p-text">愿新的一年</p>-->
            <!--<p class="write p-text">你与阳光，共赴新的精彩</p>-->
        </div>
        <div class="item erweima">
            <img src="./image/erweima.jpeg" alt="">
            <p class="yellow">分享阳光成就梦想</p>
        </div>
    </div>
    <div id = "shareImg">
        <!--<img src="" alt="">-->
    </div>
    <div class="item makeTable">
        <div class="button black" onclick="openSearch(2);">
            <p>制作我的</p>
            <p>阳光大数据</p>
        </div>
    </div>
    <div class="item makeTable lastMakeTable">
        <div class="button black" onclick="changeImg();">
            <p>一键转化图片</p>
        </div>
        <div class="button black" id="save">
            <img src="" alt="">
            <a href="javascript:void(0)" download="tupian">长按键保存</a>
        </div>
    </div>
</div>
<script type="text/javascript" src="//res.wx.qq.com/open/js/jweixin-1.3.0.js"></script>
<script src="//apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script>
<script src = './js/html2canvas.min.js'></script>
<script>
    const countArr=[
        {
            title:'周末课堂',
            img:'/ygkt_count.png',
            status:'ygkt_count'
        },
        {
            title:'培训交流',
            img:'/ygpx_count.png',
            status:'ygpx_count'
        },
        {
            title:'阳光例会',
            img:'/yglh_count.png',
            status:'yglh_count'
        },
        {
            title:'休闲活动',
            img:'/ygxx_count.png',
            status:'ygxx_count'
        },
        {
            title:'其他公益',
            img:'/ygwb_count.png',
            status:'ygwb_count'
        }
    ];
    const yearName =['壹','贰','叁','肆','伍','陆','柒','捌','玖','拾'];

    window.onload = function () {
        console.log('加载');
        let url = window.location.href;
        if(url.indexOf("#")>-1){
            let urlHash = window.location.hash.slice(1);
            getHttp(urlHash);
        }else{
            $("#loading").hide();
            $("#searchBox").show();
            stopScroll()
        }
    };

    //获取数据
    function getHttp(name) {
        $.get('https://squirrelrao.com/v1/px_ygclub_report?username='+name,(Data)=>{
            const data = Data.result || {};
            console.log(data);
            if(data.user){
                $('html,body').animate({scrollTop:0},'slow');
                $("#save").hide();
                $("#shareImg").hide();
                $("#showShare").show();
                $("#userName").html('<img src="'+data.user.avatar+'" alt="" id="userHeadpoirt">'+
                    '<p class="yellow p-text">'+data.user.username+'</p>');
                let joinFirstInfo = '';
                joinFirstInfo += '<p class="write p-html tl">Hi,亲爱的阳光er,</p>';
                joinFirstInfo += ' <p class="write p-html tl">欢迎进入阳光回忆之旅！</p>';
                if(data.user.regdate_timestamp){
                    joinFirstInfo += '<p class="yellow p-html tl">'+format(data.user.regdate_timestamp)+'</p>';
                    joinFirstInfo += '<p class="write p-html tl">你注册了论坛，加入了阳光大家庭！</p>';
                }
                let  yghd_starttime = data.detail.time.yghd_starttime || '';
                if(yghd_starttime){
                    yghd_starttime = strJion(yghd_starttime);
                    joinFirstInfo += '<p class="yellow p-html tr">'+yghd_starttime+'</p>';
                    joinFirstInfo += '<p class="write p-html tr">你参加了阳光的新人培训。</p>';
                }
                if(data.detail.tongqisheng.length>0){
                    let tongqisheng = data.detail.tongqisheng.join('、');
                    joinFirstInfo += '<p class="yellow p-html tr">'+tongqisheng+'</p>';
                    joinFirstInfo += '<p class="write p-html tr">等阳光er是你的同期生。</p>';
                }
                //加入阳光的时间
                $('#joinFirstInfo').html(joinFirstInfo);

                if(data.detail.first_info || data.detail.zhujiang_info){
                    let firstInfo ='<h2 class="title-bj yellow-title">公益活动报告</h2>';
                    if(data.detail.first_info){
                        firstInfo+='<div class="html-padding">';
                        firstInfo+='<div class="html-padding-img l-p"><img src="./image/firInfo-first.png" alt=""></div>';
                        firstInfo+='<p class="yellow p-html tr">'+data.detail.first_info.school_name+'</p>';
                        firstInfo+='<p class="yellow p-html tr">'+strJion(data.detail.first_info.school_date)+'</p>';
                        firstInfo+='<p class="write p-html tr">是你服务的第一个项目点</p>';
                        firstInfo+='</div>';

                    }
                    if(data.detail.zhujiang_info.zhujiang_count>0){
                        firstInfo+='<div class="html-padding">';
                        firstInfo+='<div class="html-padding-img r-p"><img src="./image/firstInfo-last.png" alt=""></div>';
                        firstInfo+='<p class="yellow p-html tl">'+strJion(data.detail.zhujiang_info.first_zhujiang_date)+'</p>';
                        firstInfo+='<p class="write p-html tl">在'+data.detail.zhujiang_info.first_zhujiang_school+'</p>';
                        firstInfo+='<p class="write p-html tl">你第一次登上讲台，成为主讲。</p>';
                        firstInfo+='</div>';
                    }
                    $("#firstInfo").html(firstInfo);
                }

                if(data.detail.count){
                    let countNumber = '';
                    countNumber += '<h2 class="title-bj write-title">截止目前</h2>';
                    countNumber += '<p class="write p-text">您参与的阳光公益活动</p>';
                    countNumber += '<p class="yellow p-text">'+data.detail.count.yghd_count+'次</p>';
                    countNumber += '<ul class="list html-padding">';

                    for( let i = 0 ; i < countArr.length ; i ++){
                        countNumber += '<li class="yellow">';
                        countNumber += '<p class="p-html-title">'+countArr[i].title+'</p>';
                        countNumber += '<div class="listImg">';
                        countNumber += '<img src="./image'+countArr[i].img+'" alt="">';
                        countNumber += '</div>';
                        countNumber += '<p>'+data.detail.count[countArr[i].status]+'次</p>';
                        countNumber += '</li>';
                    }
                    countNumber += '</ul>';
                    $("#countNumber").html(countNumber);
                }

                let constTime = '';
                constTime +='<h2 class="title-bj write-title">截止目前</h2>';
                constTime +='<p class="write p-text">您已为阳光公益支教活动服务</p>';
                constTime +='<p class="yellow p-text">'+data.detail.time.ygkt_hour+'小时</p>';

                if(data.detail.school.school_list.length>0){
                    constTime +='<div class="html-padding">';
                    constTime +='<p class="write p-html tl">服务过的项目点包括</p>';
                    constTime +='<p class="yellow p-html tl">'+data.detail.school.school_list.join("、")+'</p>';
                    constTime +='<p class="write p-html tr">等<span class="yellow">'+data.detail.school.school_count+'</span>个项目点</p>';
                    constTime +='</div>';
                }

                if(data.detail.zhujiang_info.teach_plan_count){
                    constTime +='<div class="html-padding">';
                    constTime +='<div class="html-padding-img r-p"><img src="./image/const-zhujiang_count.png" alt=""></div>';
                    constTime +='<p class="write p-html tl">参与教案设计次数</p>';
                    constTime +='<p class="yellow p-html tl">'+data.detail.zhujiang_info.teach_plan_count+'次</p>';
                    constTime +='</div>';
                }

                if(data.detail.zhujiang_info.jiaoan_count){
                    constTime +='<div class="html-padding">';
                    constTime +='<div class="html-padding-img l-p"><img src="./image/const-jiaoan_count.png" alt=""></div>';
                    constTime +='<p class="write p-html tr">开发的教案数</p>';
                    constTime +='<p class="yellow p-html tr">'+data.detail.zhujiang_info.jiaoan_count+'个</p>';
                    constTime +='</div>';
                }

                if(data.detail.count.kids_count){
                    constTime +='<div class="html-padding">';
                    constTime +='<div class="html-padding-img r-p"><img src="./image/const-kids_count.png" alt=""></div>';
                    constTime +='<p class="write p-html tl">服务流动儿童</p>';
                    constTime +='<p class="yellow p-html tl">'+data.detail.count.kids_count+'+</p>';
                    constTime +='</div>';
                }

                if(data.detail.zhujiang_info.zhujiang_count){
                    constTime +='<div class="html-padding">';
                    constTime +='<div class="html-padding-img l-p"><img src="./image/const-zhujiang_count.png" alt=""></div>';
                    constTime +='<p class="write p-html tr">主讲次数</p>';
                    constTime +='<p class="yellow p-html tr">'+data.detail.zhujiang_info.zhujiang_count+'次</p>';
                    constTime +='</div>';
                }
                $("#constTime").html(constTime);

                let alertJoin = '';
                const lastTime = formatYear(data.detail.time.yghd_endtime);
                const firstTime = formatYear(data.detail.time.yghd_starttime);
                alertJoin += '<h2 class="title-bj yellow-title">'+firstTime+'-'+lastTime+'</h2>';

                const nowTime = lastTime - firstTime;
                let timeHTml = yearName[0];
                if(nowTime<10){
                    timeHTml = yearName[nowTime];
                }else if(nowTime ===10){
                    timeHTml = yearName[9];
                }else if(nowTime >10 && nowTime <20){
                    const ten = Math.floor(nowTime/10);
                    timeHTml = yearName[9];
                    const ge = nowTime - ten*10;
                    timeHTml += yearName[ge-1];
                }else if (nowTime>=20){
                    const ten = Math.floor(nowTime/10);
                    timeHTml = yearName[ten] + '拾';
                    const ge = nowTime - ten*10;
                    timeHTml += yearName[ge-1] || '';
                }
                alertJoin += '<p class="write p-text">阳光 <span class="yellow">'+timeHTml+'</span>年了</p>';
                alertJoin += '<p class="write p-text">感谢你的辛勤付出</p>';
                alertJoin += '<p class="write p-text">愿新的一年</p>';
                alertJoin += '<p class="write p-text">你与阳光，共赴新的精彩</p>';
                $("#alertJoin").html(alertJoin);
                canScroll();
            }else{
                $('#noSearchBox').show();
                stopScroll();
            }
            $("#loading").hide();
        });
    }
    //现实搜索
    function openSearch(type) {
        if(type === 1){
            $('#noSearchBox').hide();
            $('#searchBox').show();
            stopScroll();
        }else if (type === 2){
            $('#searchBox').show();
            stopScroll();
        }
    }
    //搜索人员
    function searchName() {
        const val = $('#searchValue').val();
        if(val){
            let url = window.location.href;
            if(url.indexOf("#")>-1){
                url = url.slice(0,url.indexOf("#"));
            }
            window.location =  url +'#'+val;
            $("#searchBox").hide();
            getHttp(val);
        }
    }
    //关闭取消
    function closeSearch() {
        $('#searchBox').hide();
        canScroll();
    }
    function changeImg() {
        console.log("转化图片");
        html2canvas(document.querySelector("#showShare"),{
            useCORS: true
        }).then(canvas => {
            canvas.setAttribute('id','canvas');
            document.body.appendChild(canvas);
            $("#canvas").hide();
            getImg();
        });
    }
    function getImg() {
        var canvas = $("#canvas")[0],
            url = canvas.toDataURL();
        url = url.replace("image/png", "image/octet-stream");
        if(window.__wxjs_environment === 'miniprogram'){
            console.log(true);
            console.log(wx);
            wx.saveImageToPhotosAlbum({
                url:url,
                success(res) {
                    console.log(res)
                }
            })
        }
        saveImg(canvas);
        document.body.removeChild($("#canvas")[0]);

    }
    function format(shijianchuo){
        //shijianchuo是整数，否则要parseInt转换
        shijianchuo = shijianchuo * 1000;
        var time = new Date(shijianchuo);
        var y = time.getFullYear();
        var m = time.getMonth()+1;
        var d = time.getDate();
        return y+'年'+m+'月'+d+'日';
    }
    function strJion(str) {
        str =  str.split('-');
        return str[0]+'年'+str[1]+'月'+str[2]+'日'
    }
    function formatYear(str){
        str =  str.split('-');
        return str[0];
    }
    function stopScroll() {
        $("body").addClass('overflow');
    }
    function canScroll() {
        $("body").removeClass('overflow')
    }
    function saveImg(canvas){
        var dataImg = canvas.toDataURL('image/png');
        $("#save").show();
        $("#save > a").attr("href",dataImg);
        $("#save > img").attr("src",dataImg);
        var image = new Image();
        image.src = dataImg;
        image.onload  = ()=>{
            $("#shareImg").html(image);
            $("#shareImg").show();
            $("#showShare").hide();
        };
    }

</script>
</body>
</html>